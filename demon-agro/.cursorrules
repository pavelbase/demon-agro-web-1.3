Cursor Prompt: D√©mon Agro ‚Äì U≈æivatelsk√Ω Port√°l

üìã P≈ôehled projektu

Kontext
Roz≈°i≈ôuje≈° existuj√≠c√≠ Next.js 14 web pro firmu D√©mon Agro (slu≈æby v√°pnƒõn√≠ p≈Ødy pro ƒçesk√© zemƒõdƒõlce). Web ji≈æ existuje v repository a obsahuje hlavn√≠ str√°nky, kalkulaƒçky, admin panel pro spr√°vu obsahu a obr√°zk≈Ø.

Tv≈Øj √∫kol: Implementovat kompletn√≠ u≈æivatelsk√Ω port√°l pro zemƒõdƒõlsk√© podniky, kter√Ω jim umo≈æn√≠ spravovat sv√© pozemky, nahr√°vat p≈Ødn√≠ rozbory (PDF), z√≠sk√°vat pl√°ny hnojen√≠ a v√°pnƒõn√≠.

Kl√≠ƒçov√© principy
- Pou≈æij existuj√≠c√≠ design syst√©m ‚Äì barvy, fonty, komponenty z projektu
- V≈°e v ƒçe≈°tinƒõ ‚Äì UI, chybov√© hl√°≈°ky, koment√°≈ôe v k√≥du
- Supabase jako backend ‚Äì PostgreSQL, Auth, Storage
- Claude Vision API ‚Äì pro extrakci dat z PDF
- Responsivn√≠ design ‚Äì prim√°rnƒõ desktop, ale funkƒçn√≠ na mobilu

üõ†Ô∏è Tech Stack

Existuj√≠c√≠:
- Next.js 14 (App Router)
- TypeScript
- Tailwind CSS
- localStorage pro CMS obsah (admin panel)
- EmailJS pro formul√°≈ôe

Nov√© (k implementaci):
- Supabase (PostgreSQL + Auth + Storage)
- Claude Vision API (@anthropic-ai/sdk)
- React Hook Form + Zod (validace formul√°≈ô≈Ø)
- Recharts (grafy)
- jsPDF + xlsx (exporty)

üìÅ Struktura URL

/portal                     ‚Üí Landing page (info + p≈ôihl√°≈°en√≠)
/portal/prihlaseni          ‚Üí Login str√°nka
/portal/reset-hesla         ‚Üí Reset hesla (s tokenem)
/portal/onboarding          ‚Üí Wizard pro nov√© u≈æivatele
/portal/dashboard           ‚Üí Hlavn√≠ p≈ôehled
/portal/pozemky             ‚Üí Seznam pozemk≈Ø
/portal/pozemky/[id]        ‚Üí Detail pozemku
/portal/pozemky/[id]/rozbory    ‚Üí Historie rozbor≈Ø
/portal/pozemky/[id]/plan-hnojeni ‚Üí Pl√°n hnojen√≠
/portal/pozemky/[id]/plan-vapneni ‚Üí Pl√°n v√°pnƒõn√≠
/portal/upload              ‚Üí Upload PDF
/portal/historie-hnojeni    ‚Üí Zad√°n√≠ historie hnojen√≠
/portal/osevni-postup       ‚Üí Import osevn√≠ho postupu
/portal/poptavky            ‚Üí Moje popt√°vky v√°pnƒõn√≠
/portal/nastaveni           ‚Üí Nastaven√≠ √∫ƒçtu

/portal/admin               ‚Üí Admin dashboard (pouze role admin)
/portal/admin/uzivatele     ‚Üí Spr√°va u≈æivatel≈Ø
/portal/admin/uzivatele/[id] ‚Üí Detail u≈æivatele (read-only)
/portal/admin/produkty      ‚Üí Katalog hnojiv
/portal/admin/produkty-vapneni ‚Üí Katalog v√°pn√≠c√≠ch produkt≈Ø
/portal/admin/poptavky      ‚Üí P≈ôehled popt√°vek
/portal/admin/obrazky-portalu ‚Üí Spr√°va obr√°zk≈Ø landing page
/portal/admin/audit-log     ‚Üí Log admin p≈ô√≠stup≈Ø
/portal/admin/statistiky    ‚Üí Agregovan√© statistiky

üóÑÔ∏è Datab√°zov√© sch√©ma (Supabase PostgreSQL)

```sql
-- ============================================
-- USERS & COMPANIES
-- ============================================

-- Roz≈°√≠≈ôen√≠ Supabase Auth users
CREATE TABLE public.profiles (
    id UUID REFERENCES auth.users(id) PRIMARY KEY,
    email TEXT NOT NULL,
    role TEXT NOT NULL DEFAULT 'user' CHECK (role IN ('admin', 'user')),
    company_name TEXT,
    ico TEXT,
    address TEXT,
    district TEXT, -- pro dopravn√≠ z√≥ny
    phone TEXT,
    is_active BOOLEAN DEFAULT true,
    onboarding_completed BOOLEAN DEFAULT false,
    must_change_password BOOLEAN DEFAULT true,
    ai_extractions_today INTEGER DEFAULT 0,
    ai_extractions_limit INTEGER DEFAULT 10,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- RLS policies
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view own profile" ON public.profiles
    FOR SELECT USING (auth.uid() = id);
    
CREATE POLICY "Users can update own profile" ON public.profiles
    FOR UPDATE USING (auth.uid() = id);

CREATE POLICY "Admins can view all profiles" ON public.profiles
    FOR SELECT USING (
        EXISTS (SELECT 1 FROM public.profiles WHERE id = auth.uid() AND role = 'admin')
    );

CREATE POLICY "Admins can update all profiles" ON public.profiles
    FOR ALL USING (
        EXISTS (SELECT 1 FROM public.profiles WHERE id = auth.uid() AND role = 'admin')
    );

-- ============================================
-- PARCELS (Pozemky)
-- ============================================

CREATE TABLE public.parcels (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    user_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE NOT NULL,
    code TEXT, -- LPIS/AZZP k√≥d (nap≈ô. 0701/27)
    custom_name TEXT, -- vlastn√≠ n√°zev
    area_ha DECIMAL(10,2) NOT NULL CHECK (area_ha >= 0.1),
    soil_type TEXT CHECK (soil_type IN ('L', 'S', 'T')), -- Lehk√°/St≈ôedn√≠/Tƒõ≈æk√°
    culture TEXT CHECK (culture IN ('orna', 'ttp')), -- Orn√° p≈Øda / TTP
    sampling_depth INTEGER DEFAULT 30, -- cm (30 pro ornou, 15 pro TTP)
    status TEXT DEFAULT 'active' CHECK (status IN ('active', 'archived')),
    source_parcel_id UUID REFERENCES public.parcels(id), -- p≈ôi rozdƒõlen√≠/slouƒçen√≠
    notes TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_parcels_user ON public.parcels(user_id);
CREATE INDEX idx_parcels_status ON public.parcels(status);

ALTER TABLE public.parcels ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can manage own parcels" ON public.parcels
    FOR ALL USING (auth.uid() = user_id);

-- ============================================
-- SOIL ANALYSES (P≈Ødn√≠ rozbory)
-- ============================================

CREATE TABLE public.soil_analyses (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    parcel_id UUID REFERENCES public.parcels(id) ON DELETE CASCADE NOT NULL,
    analysis_date DATE NOT NULL,
    source_document TEXT, -- cesta k PDF v Storage
    methodology TEXT DEFAULT 'mehlich3' CHECK (methodology IN ('mehlich3', 'vdlufa')),
    
    -- Hodnoty ≈æivin (mg/kg)
    ph DECIMAL(4,2) CHECK (ph BETWEEN 3.5 AND 9.0),
    p DECIMAL(8,2) CHECK (p >= 0), -- Fosfor
    k DECIMAL(8,2) CHECK (k >= 0), -- Drasl√≠k
    mg DECIMAL(8,2) CHECK (mg >= 0), -- Ho≈ôƒç√≠k
    ca DECIMAL(10,2) CHECK (ca >= 0), -- V√°pn√≠k
    s DECIMAL(8,2) CHECK (s >= 0), -- S√≠ra
    
    -- Kategorie z√°sobenosti (N/VH/D/V/VV)
    ph_category TEXT CHECK (ph_category IN ('EK', 'SK', 'N', 'SZ', 'EZ')),
    p_category TEXT CHECK (p_category IN ('N', 'VH', 'D', 'V', 'VV')),
    k_category TEXT CHECK (k_category IN ('N', 'VH', 'D', 'V', 'VV')),
    mg_category TEXT CHECK (mg_category IN ('N', 'VH', 'D', 'V', 'VV')),
    s_category TEXT CHECK (s_category IN ('N', 'VH', 'D', 'V', 'VV')),
    
    -- Dopl≈àkov√© √∫daje
    kvk DECIMAL(8,2), -- Kationtov√° v√Ωmƒõnn√° kapacita (mmol/kg)
    base_saturation DECIMAL(5,2), -- Nasycen√≠ bazemi (%)
    k_mg_ratio DECIMAL(5,2), -- Pomƒõr K:Mg
    
    -- Metadata
    ai_extracted BOOLEAN DEFAULT false,
    user_validated BOOLEAN DEFAULT false,
    is_current BOOLEAN DEFAULT true, -- nejnovƒõj≈°√≠ rozbor
    version_number INTEGER DEFAULT 1,
    extraction_confidence DECIMAL(5,2), -- 0-100%
    
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_analyses_parcel ON public.soil_analyses(parcel_id);
CREATE INDEX idx_analyses_current ON public.soil_analyses(parcel_id, is_current) WHERE is_current = true;

ALTER TABLE public.soil_analyses ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can manage own analyses" ON public.soil_analyses
    FOR ALL USING (
        EXISTS (SELECT 1 FROM public.parcels WHERE id = parcel_id AND user_id = auth.uid())
    );

-- ============================================
-- FERTILIZATION HISTORY (Historie hnojen√≠)
-- ============================================

CREATE TABLE public.fertilization_history (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    parcel_id UUID REFERENCES public.parcels(id) ON DELETE CASCADE NOT NULL,
    year TEXT NOT NULL, -- Hospod√°≈ôsk√Ω rok: "HY2024/25"
    crop TEXT, -- Plodina
    yield_t_ha DECIMAL(8,2), -- V√Ωnos t/ha
    
    -- Zdroj dat
    data_source TEXT DEFAULT 'average' CHECK (data_source IN ('average', 'imported', 'manual', 'inherited')),
    source_document TEXT,
    inherited_from_parcel_id UUID REFERENCES public.parcels(id),
    
    -- Aplikovan√° hnojiva (JSON array)
    fertilizers JSONB DEFAULT '[]'::jsonb,
    -- Struktura: [{ "product_id": "uuid", "name": "DAM 390", "amount_kg_ha": 200, "date": "2024-03-15" }]
    
    -- Celkov√Ω p≈ô√≠vod ≈æivin (kg/ha)
    total_n DECIMAL(8,2) DEFAULT 0,
    total_p2o5 DECIMAL(8,2) DEFAULT 0,
    total_k2o DECIMAL(8,2) DEFAULT 0,
    total_mgo DECIMAL(8,2) DEFAULT 0,
    total_s DECIMAL(8,2) DEFAULT 0,
    total_cao DECIMAL(8,2) DEFAULT 0,
    
    -- Acidifikace z hnojiv
    acidification_caco3_kg DECIMAL(8,2) DEFAULT 0,
    
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    
    UNIQUE(parcel_id, year)
);

ALTER TABLE public.fertilization_history ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can manage own history" ON public.fertilization_history
    FOR ALL USING (
        EXISTS (SELECT 1 FROM public.parcels WHERE id = parcel_id AND user_id = auth.uid())
    );

-- ============================================
-- CROP ROTATIONS (Osevn√≠ postupy)
-- ============================================

CREATE TABLE public.crop_rotations (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    parcel_id UUID REFERENCES public.parcels(id) ON DELETE CASCADE NOT NULL,
    year TEXT NOT NULL, -- "HY2024/25"
    crop_code TEXT, -- K√≥d plodiny z ƒç√≠seln√≠ku
    crop_name TEXT NOT NULL,
    planned_yield_t_ha DECIMAL(8,2),
    actual_yield_t_ha DECIMAL(8,2),
    source TEXT DEFAULT 'manual' CHECK (source IN ('manual', 'lpis_import')),
    
    created_at TIMESTAMPTZ DEFAULT NOW(),
    
    UNIQUE(parcel_id, year)
);

ALTER TABLE public.crop_rotations ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can manage own rotations" ON public.crop_rotations
    FOR ALL USING (
        EXISTS (SELECT 1 FROM public.parcels WHERE id = parcel_id AND user_id = auth.uid())
    );

-- ============================================
-- FERTILIZATION PLANS (Pl√°ny hnojen√≠)
-- ============================================

CREATE TABLE public.fertilization_plans (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    parcel_id UUID REFERENCES public.parcels(id) ON DELETE CASCADE NOT NULL,
    target_year TEXT NOT NULL, -- "HY2025/26"
    
    -- Typ pl√°nu
    plan_type TEXT DEFAULT 'simple' CHECK (plan_type IN ('simple', 'advanced')),
    user_type TEXT CHECK (user_type IN ('A', 'B', 'C')), -- Automaticky detekovan√Ω typ
    
    -- Doporuƒçen√© v√°pnƒõn√≠
    recommended_lime_t_ha DECIMAL(6,2),
    recommended_lime_type TEXT, -- 'calcitic' / 'dolomite'
    
    -- Doporuƒçen√© ≈æiviny (kg/ha)
    recommended_nutrients JSONB DEFAULT '{}'::jsonb,
    -- Struktura: { "n": 120, "p2o5": 40, "k2o": 80, "mgo": 20, "s": 15 }
    
    -- Doporuƒçen√© produkty
    recommended_products JSONB DEFAULT '[]'::jsonb,
    -- Struktura: [{ "product_id": "uuid", "name": "NPK 15-15-15", "amount_kg_ha": 300, "reason": "Doplnƒõn√≠ P a K" }]
    
    -- Varov√°n√≠ a pozn√°mky
    warnings JSONB DEFAULT '[]'::jsonb,
    -- Struktura: [{ "type": "high_p", "severity": "warning", "message": "Vysok√° z√°sobenost P - omezit hnojen√≠" }]
    
    -- Predikce (pro pokroƒçil√Ω pl√°n)
    predictions JSONB DEFAULT '{}'::jsonb,
    -- Struktura: { "years": [2025, 2026, 2027, 2028], "ph": [6.2, 6.1, 6.0, 5.9], "p": [...], ... }
    
    generated_at TIMESTAMPTZ DEFAULT NOW(),
    
    UNIQUE(parcel_id, target_year)
);

ALTER TABLE public.fertilization_plans ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can manage own plans" ON public.fertilization_plans
    FOR ALL USING (
        EXISTS (SELECT 1 FROM public.parcels WHERE id = parcel_id AND user_id = auth.uid())
    );

-- ============================================
-- PRODUCTS (Katalog hnojiv)
-- ============================================

CREATE TABLE public.products (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    name TEXT NOT NULL,
    type TEXT CHECK (type IN ('mineral', 'organic', 'organomineral', 'lime')),
    manufacturer TEXT,
    
    -- Slo≈æen√≠ (%)
    composition JSONB DEFAULT '{}'::jsonb,
    -- Struktura: { "n": 27, "p2o5": 0, "k2o": 0, "mgo": 4, "s": 3, "cao": 0 }
    
    -- Acidifikaƒçn√≠ faktor (kg CaCO3 na kg N)
    acidification_factor DECIMAL(4,2) DEFAULT 0,
    
    -- Pro v√°pence
    is_calcitic BOOLEAN DEFAULT false, -- Kalcitick√Ω
    is_dolomite BOOLEAN DEFAULT false, -- Dolomitick√Ω
    cao_content DECIMAL(5,2), -- % CaO
    mgo_content DECIMAL(5,2), -- % MgO
    reactivity TEXT, -- 'slow', 'medium', 'fast'
    
    is_active BOOLEAN DEFAULT true,
    is_demon_product BOOLEAN DEFAULT false, -- Produkty D√©mon Agro
    
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Ve≈ôejnƒõ ƒçiteln√©, pouze admin m≈Ø≈æe upravovat
ALTER TABLE public.products ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Anyone can view active products" ON public.products
    FOR SELECT USING (is_active = true);

CREATE POLICY "Admins can manage products" ON public.products
    FOR ALL USING (
        EXISTS (SELECT 1 FROM public.profiles WHERE id = auth.uid() AND role = 'admin')
    );

-- ============================================
-- LIMING REQUESTS (Popt√°vky v√°pnƒõn√≠)
-- ============================================

CREATE TABLE public.liming_requests (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    user_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE NOT NULL,
    
    status TEXT DEFAULT 'new' CHECK (status IN ('new', 'in_progress', 'quoted', 'completed', 'cancelled')),
    
    -- Souhrnn√© √∫daje
    total_area_ha DECIMAL(10,2),
    total_quantity_t DECIMAL(10,2),
    
    -- Preference z√°kazn√≠ka
    preferred_term TEXT, -- "jaro 2025", "podzim 2025"
    note TEXT,
    
    -- Admin pozn√°mky
    admin_note TEXT,
    quoted_price DECIMAL(12,2),
    
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

ALTER TABLE public.liming_requests ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view own requests" ON public.liming_requests
    FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "Users can create requests" ON public.liming_requests
    FOR INSERT WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Admins can manage all requests" ON public.liming_requests
    FOR ALL USING (
        EXISTS (SELECT 1 FROM public.profiles WHERE id = auth.uid() AND role = 'admin')
    );

-- ============================================
-- LIMING REQUEST ITEMS (Polo≈æky popt√°vky)
-- ============================================

CREATE TABLE public.liming_request_items (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    request_id UUID REFERENCES public.liming_requests(id) ON DELETE CASCADE NOT NULL,
    parcel_id UUID REFERENCES public.parcels(id) ON DELETE CASCADE NOT NULL,
    
    recommended_type TEXT CHECK (recommended_type IN ('calcitic', 'dolomite', 'either')),
    recommended_product_id UUID REFERENCES public.products(id),
    
    quantity_cao_t DECIMAL(8,2), -- Pot≈ôeba CaO v tun√°ch
    quantity_product_t DECIMAL(8,2), -- Mno≈æstv√≠ produktu v tun√°ch
    
    reason TEXT, -- D≈Øvod doporuƒçen√≠ typu v√°pence
    
    created_at TIMESTAMPTZ DEFAULT NOW()
);

ALTER TABLE public.liming_request_items ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view own items" ON public.liming_request_items
    FOR SELECT USING (
        EXISTS (SELECT 1 FROM public.liming_requests WHERE id = request_id AND user_id = auth.uid())
    );

CREATE POLICY "Users can create items for own requests" ON public.liming_request_items
    FOR INSERT WITH CHECK (
        EXISTS (SELECT 1 FROM public.liming_requests WHERE id = request_id AND user_id = auth.uid())
    );

CREATE POLICY "Admins can manage all items" ON public.liming_request_items
    FOR ALL USING (
        EXISTS (SELECT 1 FROM public.profiles WHERE id = auth.uid() AND role = 'admin')
    );

-- ============================================
-- PORTAL IMAGES (Obr√°zky pro landing page)
-- ============================================

CREATE TABLE public.portal_images (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    title TEXT NOT NULL,
    description TEXT,
    image_url TEXT NOT NULL,
    display_order INTEGER DEFAULT 0,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

ALTER TABLE public.portal_images ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Anyone can view active images" ON public.portal_images
    FOR SELECT USING (is_active = true);

CREATE POLICY "Admins can manage images" ON public.portal_images
    FOR ALL USING (
        EXISTS (SELECT 1 FROM public.profiles WHERE id = auth.uid() AND role = 'admin')
    );

-- ============================================
-- ADMIN AUDIT LOG (Logov√°n√≠ p≈ô√≠stupu admina)
-- ============================================

CREATE TABLE public.admin_audit_log (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    admin_id UUID REFERENCES public.profiles(id) NOT NULL,
    target_user_id UUID REFERENCES public.profiles(id), -- NULL pro syst√©mov√© akce
    action TEXT NOT NULL, 
    -- Mo≈æn√© akce: 'view_user_parcels', 'view_user_analyses', 'view_user_plans', 
    -- 'view_user_history', 'reset_password', 'create_user', 'deactivate_user', 
    -- 'activate_user', 'update_ai_limit', 'view_audit_log'
    details JSONB DEFAULT '{}'::jsonb, -- Detaily akce (nap≈ô. parcel_id, zmƒõnƒõn√© hodnoty)
    ip_address TEXT,
    user_agent TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_audit_admin ON public.admin_audit_log(admin_id);
CREATE INDEX idx_audit_target ON public.admin_audit_log(target_user_id);
CREATE INDEX idx_audit_action ON public.admin_audit_log(action);
CREATE INDEX idx_audit_date ON public.admin_audit_log(created_at DESC);

ALTER TABLE public.admin_audit_log ENABLE ROW LEVEL SECURITY;

-- Pouze admin m≈Ø≈æe ƒç√≠st audit log
CREATE POLICY "Admins can view audit log" ON public.admin_audit_log
    FOR SELECT USING (
        EXISTS (SELECT 1 FROM public.profiles WHERE id = auth.uid() AND role = 'admin')
    );

-- Insert povolen pro v≈°echny (syst√©m loguje)
CREATE POLICY "System can insert audit log" ON public.admin_audit_log
    FOR INSERT WITH CHECK (true);

-- ============================================
-- PASSWORD RESET TOKENS (pro self-service reset)
-- ============================================
-- Pozn√°mka: Supabase Auth m√° vestavƒõn√Ω password reset,
-- ale pro vlastn√≠ flow m≈Ø≈æeme pou≈æ√≠t tuto tabulku

CREATE TABLE public.password_reset_tokens (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    user_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE NOT NULL,
    token TEXT NOT NULL UNIQUE,
    expires_at TIMESTAMPTZ NOT NULL,
    used_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_reset_token ON public.password_reset_tokens(token);
CREATE INDEX idx_reset_user ON public.password_reset_tokens(user_id);

ALTER TABLE public.password_reset_tokens ENABLE ROW LEVEL SECURITY;

-- Nikdo nem≈Ø≈æe p≈ô√≠mo ƒç√≠st tokeny (pouze p≈ôes server funkce)
CREATE POLICY "No direct access to tokens" ON public.password_reset_tokens
    FOR ALL USING (false);

-- ============================================
-- HELPER FUNCTIONS
-- ============================================

-- Trigger pro aktualizaci updated_at
CREATE OR REPLACE FUNCTION update_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_profiles_updated_at BEFORE UPDATE ON public.profiles
    FOR EACH ROW EXECUTE FUNCTION update_updated_at();

CREATE TRIGGER update_parcels_updated_at BEFORE UPDATE ON public.parcels
    FOR EACH ROW EXECUTE FUNCTION update_updated_at();

CREATE TRIGGER update_analyses_updated_at BEFORE UPDATE ON public.soil_analyses
    FOR EACH ROW EXECUTE FUNCTION update_updated_at();

CREATE TRIGGER update_history_updated_at BEFORE UPDATE ON public.fertilization_history
    FOR EACH ROW EXECUTE FUNCTION update_updated_at();

CREATE TRIGGER update_products_updated_at BEFORE UPDATE ON public.products
    FOR EACH ROW EXECUTE FUNCTION update_updated_at();

CREATE TRIGGER update_requests_updated_at BEFORE UPDATE ON public.liming_requests
    FOR EACH ROW EXECUTE FUNCTION update_updated_at();

-- Funkce pro oznaƒçen√≠ star√Ωch rozbor≈Ø jako neaktu√°ln√≠ch
CREATE OR REPLACE FUNCTION mark_old_analyses_not_current()
RETURNS TRIGGER AS $$
BEGIN
    IF NEW.is_current = true THEN
        UPDATE public.soil_analyses 
        SET is_current = false 
        WHERE parcel_id = NEW.parcel_id 
          AND id != NEW.id 
          AND is_current = true;
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER mark_old_analyses BEFORE INSERT OR UPDATE ON public.soil_analyses
    FOR EACH ROW EXECUTE FUNCTION mark_old_analyses_not_current();

-- Funkce pro reset denn√≠ho limitu AI extrakc√≠ (volat cronem o p≈Ølnoci)
CREATE OR REPLACE FUNCTION reset_daily_ai_limits()
RETURNS void AS $$
BEGIN
    UPDATE public.profiles SET ai_extractions_today = 0;
END;
$$ LANGUAGE plpgsql;
```

üîê Autentizace & Onboarding

Flow p≈ôihl√°≈°en√≠:
1. U≈æivatel p≈ôijde na /portal
2. Klikne "P≈ôihl√°sit se" ‚Üí /portal/prihlaseni
3. Zad√° email + heslo (Supabase Auth)
4. Kontrola:
   - is_active == false ‚Üí "√öƒçet deaktivov√°n"
   - must_change_password == true ‚Üí p≈ôesmƒõrov√°n√≠ na zmƒõnu hesla
   - onboarding_completed == false ‚Üí /portal/onboarding
   - jinak ‚Üí /portal/dashboard

Onboarding Wizard (3-4 kroky):
```typescript
// Kroky onboardingu
const ONBOARDING_STEPS = [
  {
    id: 'welcome',
    title: 'V√≠tejte v port√°lu D√©mon Agro',
    description: 'Tento port√°l v√°m pom≈Ø≈æe spravovat p≈Ødn√≠ rozbory a pl√°novat hnojen√≠.',
    skippable: false
  },
  {
    id: 'password',
    title: 'Zmƒõna hesla',
    description: 'Pro va≈°i bezpeƒçnost si pros√≠m zmƒõ≈àte heslo.',
    skippable: false, // povinn√© p≈ôi prvn√≠m p≈ôihl√°≈°en√≠
    condition: (user) => user.must_change_password
  },
  {
    id: 'company',
    title: 'Informace o podniku',
    description: 'Vypl≈àte z√°kladn√≠ √∫daje o va≈°em zemƒõdƒõlsk√©m podniku.',
    fields: ['company_name', 'ico', 'address', 'district', 'phone'],
    skippable: true
  },
  {
    id: 'first_upload',
    title: 'Prvn√≠ nahr√°n√≠ rozbor≈Ø',
    description: 'M≈Ø≈æete rovnou nahr√°t PDF s p≈Ødn√≠mi rozbory (AZZP nebo laboratorn√≠ protokol).',
    skippable: true
  }
];
```

Admin vytv√°≈ôen√≠ u≈æivatel≈Ø:
```typescript
// Server action pro vytvo≈ôen√≠ u≈æivatele (pouze admin)
async function createUser(data: {
  email: string;
  company_name: string;
  ico?: string;
}) {
  // 1. Vytvo≈ô u≈æivatele v Supabase Auth s n√°hodn√Ωm heslem
  const tempPassword = generateSecurePassword();
  const { data: authUser, error } = await supabase.auth.admin.createUser({
    email: data.email,
    password: tempPassword,
    email_confirm: true
  });
  
  // 2. Vytvo≈ô profil
  await supabase.from('profiles').insert({
    id: authUser.user.id,
    email: data.email,
    company_name: data.company_name,
    ico: data.ico,
    role: 'user',
    must_change_password: true
  });
  
  // 3. Po≈°li email s heslem p≈ôes EmailJS
  await sendWelcomeEmail(data.email, tempPassword);
}
```

üìÑ AI Extrakce PDF

Podporovan√© dokumenty:
- AZZP zpr√°va (√öKZ√öZ) ‚Äì strukturovan√° tabulka s k√≥dy pozemk≈Ø
- Laboratorn√≠ protokol ‚Äì r≈Øzn√© form√°ty od r≈Øzn√Ωch laborato≈ô√≠

Limity:
- Max 10 PDF/den/u≈æivatel (konfigurovateln√© v admin)
- Max 50 stran na jeden upload
- Podporovan√© form√°ty: PDF

Extrakƒçn√≠ flow:
```typescript
// 1. Upload PDF do Supabase Storage
const { data: file } = await supabase.storage
  .from('soil-documents')
  .upload(`${userId}/${filename}`, pdfFile);

// 2. Konverze PDF na obr√°zky (pdf-to-img nebo pdf.js)
const images = await convertPdfToImages(pdfFile);

// 3. Vol√°n√≠ Claude Vision API
const response = await anthropic.messages.create({
  model: 'claude-sonnet-4-20250514',
  max_tokens: 4096,
  messages: [{
    role: 'user',
    content: [
      ...images.map(img => ({
        type: 'image',
        source: { type: 'base64', media_type: 'image/png', data: img }
      })),
      {
        type: 'text',
        text: EXTRACTION_PROMPT
      }
    ]
  }]
});

// 4. Parsov√°n√≠ JSON odpovƒõdi
const extractedData = JSON.parse(response.content[0].text);

// 5. Ulo≈æen√≠ do DB s user_validated = false
// 6. Zobrazen√≠ u≈æivateli k validaci
```

Extrakƒçn√≠ prompt:
```typescript
const EXTRACTION_PROMPT = `
Analyzuj tento dokument s p≈Ødn√≠mi rozbory. Extrahuj data do n√°sleduj√≠c√≠ JSON struktury.

D≈ÆLE≈ΩIT√â:
- Dokument m≈Ø≈æe b√Ωt AZZP zpr√°va (strukturovan√° tabulka) nebo laboratorn√≠ protokol
- Hodnoty ≈æivin jsou v mg/kg (Mehlich 3 metodika)
- pH je bezrozmƒõrn√© ƒç√≠slo (typicky 4.5-8.0)
- Kategorie z√°sobenosti: N (n√≠zk√°), VH (velmi n√≠zk√°), D (dobr√°), V (vysok√°), VV (velmi vysok√°)
- K√≥dy pozemk≈Ø mohou b√Ωt ve form√°tu: "0701/27", "680-0970", apod.

Vra≈• POUZE validn√≠ JSON bez jak√©hokoli dal≈°√≠ho textu:

{
  "document_type": "azzp" | "laboratory",
  "analysis_date": "YYYY-MM-DD",
  "laboratory": "n√°zev laborato≈ôe pokud je uveden",
  "methodology": "mehlich3",
  "confidence": 0-100,
  "parcels": [
    {
      "code": "k√≥d pozemku",
      "area_ha": ƒç√≠slo nebo null,
      "soil_type": "L" | "S" | "T" | null,
      "culture": "orna" | "ttp" | null,
      "values": {
        "ph": ƒç√≠slo,
        "p": ƒç√≠slo (mg/kg),
        "k": ƒç√≠slo (mg/kg),
        "mg": ƒç√≠slo (mg/kg),
        "ca": ƒç√≠slo nebo null (mg/kg),
        "s": ƒç√≠slo nebo null (mg/kg),
        "kvk": ƒç√≠slo nebo null (mmol/kg)
      },
      "categories": {
        "ph": "EK" | "SK" | "N" | "SZ" | "EZ" | null,
        "p": "N" | "VH" | "D" | "V" | "VV" | null,
        "k": "N" | "VH" | "D" | "V" | "VV" | null,
        "mg": "N" | "VH" | "D" | "V" | "VV" | null,
        "s": "N" | "VH" | "D" | "V" | "VV" | null
      }
    }
  ],
  "warnings": ["p≈ô√≠padn√© probl√©my s extrakc√≠"]
}
`;
```

Validaƒçn√≠ UI:
Po extrakci zobrazit u≈æivateli tabulku s extrahovan√Ωmi daty:
- Editovateln√© bu≈àky pro opravu hodnot
- Zv√Ωraznƒõn√≠ podez≈ôel√Ωch hodnot (mimo rozsah)
- Tlaƒç√≠tko "Potvrdit a ulo≈æit"
- Mo≈ænost p≈ôidat/odebrat pozemky

P√°rov√°n√≠ s existuj√≠c√≠mi pozemky:
```typescript
// Inteligentn√≠ p√°rov√°n√≠ (sk√≥re 0-100%)
function matchParcel(extractedCode: string, existingParcels: Parcel[]): {
  match: Parcel | null;
  score: number;
  action: 'auto' | 'confirm' | 'manual';
} {
  // P≈ôesn√° shoda k√≥du
  const exactMatch = existingParcels.find(p => p.code === extractedCode);
  if (exactMatch) return { match: exactMatch, score: 100, action: 'auto' };
  
  // ƒå√°steƒçn√° shoda (nap≈ô. "0701/27" vs "701/27")
  const partialMatches = existingParcels
    .map(p => ({ parcel: p, score: calculateSimilarity(extractedCode, p.code) }))
    .filter(m => m.score > 50)
    .sort((a, b) => b.score - a.score);
  
  if (partialMatches.length > 0) {
    const best = partialMatches[0];
    return {
      match: best.parcel,
      score: best.score,
      action: best.score >= 85 ? 'confirm' : 'manual'
    };
  }
  
  return { match: null, score: 0, action: 'manual' };
}
```

üåæ Algoritmy pl√°nov√°n√≠ hnojen√≠

Typy u≈æivatel≈Ø (automatick√° detekce):
```typescript
function detectUserType(parcel: Parcel): 'A' | 'B' | 'C' {
  const hasAnalysis = parcel.soil_analyses.length > 0;
  const hasCropRotation = parcel.crop_rotations.length > 0;
  const hasFertHistory = parcel.fertilization_history.length > 0;
  
  if (hasAnalysis && hasCropRotation && hasFertHistory) return 'C'; // Profesion√°ln√≠
  if (hasAnalysis && (hasCropRotation || hasFertHistory)) return 'B'; // Pokroƒçil√Ω
  return 'A'; // Z√°kladn√≠
}
```

Typ A ‚Äì Z√°kladn√≠ pl√°n (pouze AZZP):
```typescript
interface SimplePlanInput {
  soilAnalysis: SoilAnalysis;
  parcel: Parcel;
}

function generateSimplePlan(input: SimplePlanInput): FertilizationPlan {
  const { soilAnalysis, parcel } = input;
  const isArable = parcel.culture === 'orna';
  
  // 1. V√°pnƒõn√≠ dle tabulek
  const limeRecommendation = calculateLimeNeed({
    ph: soilAnalysis.ph,
    soilType: parcel.soil_type,
    culture: parcel.culture,
    targetPh: isArable ? 6.5 : 6.0
  });
  
  // 2. Z√°kladn√≠ d√°vky ≈æivin dle z√°sobenosti
  // Pr≈Ømƒõrn√° plodina: obiloviny (orn√°) nebo louka (TTP)
  const baseYield = isArable ? 6 : 8; // t/ha
  
  const nutrients = {
    p2o5: calculatePNeed(soilAnalysis.p_category, baseYield, isArable),
    k2o: calculateKNeed(soilAnalysis.k_category, baseYield, isArable),
    mgo: calculateMgNeed(soilAnalysis.mg_category, baseYield),
    s: calculateSNeed(soilAnalysis.s_category, baseYield)
  };
  
  // 3. Korekce dle pomƒõru K:Mg
  const kMgRatio = soilAnalysis.k / soilAnalysis.mg;
  if (kMgRatio > 2.5) {
    nutrients.k2o *= 0.75; // Sn√≠≈æit K
    nutrients.mgo *= 1.25; // Zv√Ω≈°it Mg
  } else if (kMgRatio < 1.5) {
    nutrients.k2o *= 1.25;
    nutrients.mgo *= 0.75;
  }
  
  return {
    plan_type: 'simple',
    user_type: 'A',
    recommended_lime_t_ha: limeRecommendation.amount,
    recommended_lime_type: limeRecommendation.type,
    recommended_nutrients: nutrients,
    warnings: [
      {
        type: 'info',
        message: 'Bez znalosti osevn√≠ho postupu je doporuƒçen√≠ orientaƒçn√≠ (¬±25%)'
      }
    ]
  };
}
```

Tabulka pot≈ôeby v√°pnƒõn√≠:
```typescript
// Pot≈ôeba CaO v t/ha podle pH a p≈Ødn√≠ho druhu
const LIME_NEED_TABLE = {
  // Orn√° p≈Øda (c√≠lov√© pH 6.5)
  orna: {
    L: { // Lehk√° p≈Øda
      '< 5.0': 2.5,
      '5.0-5.5': 2.0,
      '5.5-6.0': 1.5,
      '6.0-6.5': 0.5,
      '> 6.5': 0
    },
    S: { // St≈ôedn√≠ p≈Øda
      '< 5.0': 3.5,
      '5.0-5.5': 3.0,
      '5.5-6.0': 2.0,
      '6.0-6.5': 1.0,
      '> 6.5': 0
    },
    T: { // Tƒõ≈æk√° p≈Øda
      '< 5.0': 4.5,
      '5.0-5.5': 4.0,
      '5.5-6.0': 3.0,
      '6.0-6.5': 1.5,
      '> 6.5': 0
    }
  },
  // TTP (c√≠lov√© pH 6.0)
  ttp: {
    L: {
      '< 5.0': 2.0,
      '5.0-5.5': 1.5,
      '5.5-6.0': 0.5,
      '> 6.0': 0
    },
    S: {
      '< 5.0': 3.0,
      '5.0-5.5': 2.0,
      '5.5-6.0': 1.0,
      '> 6.0': 0
    },
    T: {
      '< 5.0': 4.0,
      '5.0-5.5': 3.0,
      '5.5-6.0': 1.5,
      '> 6.0': 0
    }
  }
};
```

V√Ωbƒõr typu v√°pence:
```typescript
function selectLimeType(analysis: SoilAnalysis): 'calcitic' | 'dolomite' | 'either' {
  const kMgRatio = analysis.k / analysis.mg;
  
  // Dolomitick√Ω v√°penec kdy≈æ:
  // - Mg je v kategorii N nebo VH
  // - nebo K:Mg > 2.5
  if (
    ['N', 'VH'].includes(analysis.mg_category) ||
    kMgRatio > 2.5
  ) {
    return 'dolomite';
  }
  
  // Kalcitick√Ω v√°penec kdy≈æ:
  // - Mg je v kategorii D, V nebo VV
  // - a K:Mg < 2.0
  if (
    ['D', 'V', 'VV'].includes(analysis.mg_category) &&
    kMgRatio < 2.0
  ) {
    return 'calcitic';
  }
  
  // Jinak voliteln√Ω
  return 'either';
}
```

Typ C ‚Äì Pokroƒçil√Ω pl√°n (simulace 4 roky):
```typescript
interface AdvancedPlanInput {
  soilAnalysis: SoilAnalysis;
  parcel: Parcel;
  cropRotations: CropRotation[]; // 4 roky dop≈ôedu
  fertilizationHistory: FertilizationHistory[]; // minul√© roky
}

function generateAdvancedPlan(input: AdvancedPlanInput): FertilizationPlan {
  const { soilAnalysis, parcel, cropRotations, fertilizationHistory } = input;
  
  // 1. Inicializace stavu p≈Ødy
  let soilState = initializeSoilState(soilAnalysis, parcel);
  
  // 2. Zpracov√°n√≠ historie (pokud existuje)
  for (const history of fertilizationHistory) {
    soilState = processHistoricalYear(soilState, history, parcel);
  }
  
  // 3. Predikce na 4 roky
  const predictions = [];
  const recommendations = [];
  
  for (const rotation of cropRotations) {
    // V√Ωpoƒçet pot≈ôeby ≈æivin pro plodinu
    const cropNeeds = calculateCropNeeds(rotation.crop_name, rotation.planned_yield_t_ha);
    
    // V√Ωpoƒçet doporuƒçen√≠
    const yearRecommendation = calculateYearRecommendation(soilState, cropNeeds, parcel);
    recommendations.push(yearRecommendation);
    
    // Aplikace doporuƒçen√≠ a aktualizace stavu
    soilState = simulateYear(soilState, yearRecommendation, cropNeeds, parcel);
    predictions.push({ ...soilState, year: rotation.year });
  }
  
  return {
    plan_type: 'advanced',
    user_type: 'C',
    recommended_lime_t_ha: recommendations[0].lime,
    recommended_lime_type: selectLimeType(soilAnalysis),
    recommended_nutrients: recommendations[0].nutrients,
    recommended_products: recommendations[0].products,
    warnings: generateWarnings(soilState, predictions),
    predictions: {
      years: predictions.map(p => p.year),
      ph: predictions.map(p => p.ph),
      p: predictions.map(p => p.p),
      k: predictions.map(p => p.k),
      mg: predictions.map(p => p.mg)
    }
  };
}

// P≈ôepoƒçet mg/kg na kg/ha
function mgKgToKgHa(mgKg: number, depth: number = 30): number {
  // Koeficient 4.2 pro 30cm, objemov√° hmotnost ~1.4 g/cm¬≥
  const coefficient = depth === 30 ? 4.2 : 2.1; // 15cm = 2.1
  return mgKg * coefficient;
}

// Odhad KVK pokud chyb√≠
function estimateKVK(soilType: string): number {
  switch (soilType) {
    case 'L': return 80;  // mmol/kg
    case 'S': return 150;
    case 'T': return 250;
    default: return 150;
  }
}
```

Acidifikace z hnojiv:
```typescript
// kg CaCO3 na kg N
const ACIDIFICATION_FACTORS = {
  'ledek_vapenaty': 0,      // Alkalick√©
  'lav': 1.8,               // LAV/LAD
  'lad': 1.8,
  'mocovina': 2.7,          // Pr≈Ømƒõr 1.8-3.6
  'dam_390': 3.0,           // Pr≈Ømƒõr 2.5-3.6
  'ledek_amonny': 3.6,
  'dap': 5.3,
  'map': 7.0,
  'siran_amonny': 7.0,
  'elementarni_sira': 3.0   // kg CaCO3 / kg S
};

// P≈ôirozen√° acidifikace (kg CaCO3/ha/rok)
const NATURAL_ACIDIFICATION = {
  // Podle p≈Ødn√≠ho druhu a pr≈Ømƒõrn√Ωch sr√°≈æek (600mm)
  L: 60,  // 30-120 dle sr√°≈æek
  S: 50,  // 20-100
  T: 40   // 10-80
};
```

Odbƒõrov√© normativy (p≈ô√≠klady):
```typescript
// kg ≈æivin na 1 t hlavn√≠ho produktu
const CROP_NUTRIENT_UPTAKE = {
  'p≈°enice ozim√°': { n: 25, p: 5.2, k: 19.9, mg: 2.4, s: 1.5 },
  'p≈°enice jarn√≠': { n: 25, p: 5.2, k: 17.4, mg: 2.0, s: 1.5 },
  'jeƒçmen ozim√Ω': { n: 22, p: 4.4, k: 17.4, mg: 1.6, s: 1.2 },
  'jeƒçmen jarn√≠': { n: 20, p: 4.4, k: 16.6, mg: 1.6, s: 1.2 },
  '≈ôepka ozim√°': { n: 50, p: 11.0, k: 49.8, mg: 4.8, s: 8.0 },
  'kuku≈ôice zrno': { n: 27, p: 5.2, k: 23.2, mg: 4.8, s: 1.2 },
  'kuku≈ôice sil√°≈æ': { n: 3.5, p: 0.6, k: 4.6, mg: 0.6, s: 0.3 }, // na 1 t sil√°≈æe
  'cukrovka': { n: 4.4, p: 0.7, k: 4.7, mg: 0.8, s: 0.5 }, // na 1 t bulev
  'brambory': { n: 4.0, p: 0.6, k: 5.8, mg: 0.4, s: 0.3 },
  'luƒçn√≠ seno': { n: 17, p: 3.1, k: 12.5, mg: 2.4, s: 1.5 },
  'jetel': { n: 25, p: 3.5, k: 20.0, mg: 3.0, s: 2.0 },
  'vojtƒõ≈°ka': { n: 27, p: 3.5, k: 22.0, mg: 3.5, s: 2.5 }
};
```

üß™ Pl√°n v√°pnƒõn√≠ & Popt√°vky

Produkty D√©mon Agro (v√Ωchoz√≠ data):
```typescript
const DEMON_LIME_PRODUCTS = [
  {
    name: 'Superfos 500',
    type: 'calcitic',
    cao_content: 50,
    mgo_content: 2,
    reactivity: 'medium',
    is_demon_product: true
  },
  {
    name: 'Superfos 500 Mg',
    type: 'dolomite',
    cao_content: 30,
    mgo_content: 20,
    reactivity: 'medium',
    is_demon_product: true
  },
  {
    name: 'Calcite 80',
    type: 'calcitic',
    cao_content: 80,
    mgo_content: 0,
    reactivity: 'fast',
    is_demon_product: true
  },
  {
    name: 'Granucal',
    type: 'granulated',
    cao_content: 45,
    mgo_content: 5,
    reactivity: 'fast',
    is_demon_product: true
  },
  {
    name: 'Dolite 30',
    type: 'dolomite',
    cao_content: 30,
    mgo_content: 18,
    reactivity: 'slow',
    is_demon_product: true
  }
];
```

V√Ωpoƒçet mno≈æstv√≠ produktu:
```typescript
function calculateProductQuantity(
  caoNeedTonnes: number,
  product: LimeProduct
): number {
  // P≈ôepoƒçet pot≈ôeby CaO na mno≈æstv√≠ produktu
  // caoNeedTonnes = pot≈ôeba ƒçist√©ho CaO
  // product.cao_content = % CaO v produktu
  return caoNeedTonnes / (product.cao_content / 100);
}

// P≈ô√≠klad:
// Pot≈ôeba: 2 t CaO/ha
// Produkt: Superfos 500 (50% CaO)
// Mno≈æstv√≠: 2 / 0.5 = 4 t produktu/ha
```

Popt√°vkov√Ω syst√©m:
```typescript
// Vytvo≈ôen√≠ popt√°vky
async function createLimingRequest(data: {
  parcels: Array<{
    parcelId: string;
    recommendedType: 'calcitic' | 'dolomite' | 'either';
    quantityCaoT: number;
    reason: string;
  }>;
  preferredTerm: string;
  note?: string;
}) {
  const userId = await getCurrentUserId();
  
  // 1. Vytvo≈ô hlavn√≠ popt√°vku
  const { data: request } = await supabase
    .from('liming_requests')
    .insert({
      user_id: userId,
      status: 'new',
      preferred_term: data.preferredTerm,
      note: data.note,
      total_area_ha: calculateTotalArea(data.parcels),
      total_quantity_t: calculateTotalQuantity(data.parcels)
    })
    .select()
    .single();
  
  // 2. Vytvo≈ô polo≈æky
  const items = data.parcels.map(p => ({
    request_id: request.id,
    parcel_id: p.parcelId,
    recommended_type: p.recommendedType,
    quantity_cao_t: p.quantityCaoT,
    quantity_product_t: calculateProductQuantity(p.quantityCaoT, getDefaultProduct(p.recommendedType)),
    reason: p.reason
  }));
  
  await supabase.from('liming_request_items').insert(items);
  
  // 3. Ode≈°li notifikaci adminovi
  await sendEmailNotification({
    to: 'base@demonagro.cz',
    subject: `Nov√° popt√°vka v√°pnƒõn√≠ - ${request.total_quantity_t} t`,
    template: 'new_liming_request',
    data: { request, items, user: await getUser(userId) }
  });
  
  return request;
}
```

üë®‚Äçüíº Admin sekce

Co admin M≈Æ≈ΩE vidƒõt:
```typescript
// Agregovan√© statistiky
interface AdminStats {
  totalUsers: number;
  activeUsers: number;
  totalParcels: number;
  totalAreaHa: number;
  totalAnalyses: number;
  pendingRequests: number;
  aiUsageToday: number;
  totalLimeNeedT: number; // Celkov√° pot≈ôeba v√°pnƒõn√≠
  avgPh: number; // Pr≈Ømƒõrn√© pH nap≈ô√≠ƒç v≈°emi pozemky
}

// Seznam u≈æivatel≈Ø
interface UserListItem {
  id: string;
  email: string;
  company_name: string;
  ico: string;
  district: string;
  parcels_count: number;
  total_area_ha: number;
  last_login: Date;
  is_active: boolean;
  created_at: Date;
}

// Admin m√° READ-ONLY p≈ô√≠stup k dat≈Øm u≈æivatel≈Ø:
// - Seznam pozemk≈Ø u≈æivatele (k√≥d, n√°zev, v√Ωmƒõra, p≈Ødn√≠ druh)
// - Hodnoty rozbor≈Ø (pH, P, K, Mg, S, kategorie)
// - Pl√°ny hnojen√≠ a v√°pnƒõn√≠
// - Historie hnojen√≠
// - Osevn√≠ postupy
```

Co admin NEM≈Æ≈ΩE:
- Mƒõnit/editovat data u≈æivatel≈Ø (pouze read-only prohl√≠≈æen√≠)
- Mazat rozbory nebo pozemky u≈æivatel≈Ø
- Hromadnƒõ exportovat v≈°echna data v≈°ech u≈æivatel≈Ø (ochrana p≈ôed √∫nikem)

Audit Log (logov√°n√≠ p≈ô√≠stupu):
Ka≈æd√Ω admin p≈ô√≠stup k dat≈Øm konkr√©tn√≠ho u≈æivatele se loguje.

Podm√≠nky u≈æ√≠v√°n√≠ (informovat u≈æivatele):
V podm√≠nk√°ch u≈æ√≠v√°n√≠ port√°lu mus√≠ b√Ωt uvedeno:

"Provozovatel port√°lu (D√©mon Agro) m√° p≈ô√≠stup k va≈°im dat≈Øm za √∫ƒçelem:
- Zaji≈°tƒõn√≠ kvality slu≈æeb a kontroly spr√°vnosti dat
- Technick√© podpory
- P≈ô√≠pravy cenov√Ωch nab√≠dek
- Zlep≈°ov√°n√≠ produktu

P≈ô√≠stupy jsou logov√°ny. Data nejsou sd√≠lena s t≈ôet√≠mi stranami."

Admin funkce:
```typescript
// Spr√°va u≈æivatel≈Ø
- createUser(email, company_name, ico?)
- deactivateUser(userId)
- activateUser(userId)
- resetPassword(userId) // Vygeneruje nov√© heslo a po≈°le emailem
- updateAiLimit(userId, limit)
- viewUserData(userId) // Read-only p≈ô√≠stup k dat≈Øm u≈æivatele (logov√°no)

// Spr√°va produkt≈Ø
- CRUD pro hnojiva (products)
- CRUD pro v√°pn√≠c√≠ produkty

// Spr√°va popt√°vek
- listRequests(filters?)
- updateRequestStatus(requestId, status)
- addAdminNote(requestId, note)

// Spr√°va obr√°zk≈Ø port√°lu
- uploadPortalImage(file, title, description)
- updateImageOrder(imageId, order)
- deleteImage(imageId)

// Audit log
- viewAuditLog(filters?) // P≈ôehled v≈°ech admin p≈ô√≠stup≈Ø
```

Reset hesla (dvƒõ mo≈ænosti):

1. Self-service (u≈æivatel s√°m):
   /portal/prihlaseni ‚Üí "Zapomnƒõl jsem heslo"
   ‚Üí Zad√° email
   ‚Üí Supabase po≈°le reset link
   ‚Üí U≈æivatel nastav√≠ nov√© heslo

2. Admin reset (z√°loha):
   Admin sekce ‚Üí U≈æivatel√© ‚Üí [u≈æivatel] ‚Üí "Resetovat heslo"
   ‚Üí Syst√©m vygeneruje nov√© heslo
   ‚Üí Po≈°le emailem u≈æivateli
   ‚Üí U≈æivatel mus√≠ heslo zmƒõnit p≈ôi prvn√≠m p≈ôihl√°≈°en√≠

üé® UI Komponenty

Zdravotn√≠ karta pozemku:
```tsx
interface HealthCardProps {
  parcel: Parcel;
  analysis: SoilAnalysis;
}

function ParcelHealthCard({ parcel, analysis }: HealthCardProps) {
  return (
    <Card>
      <CardHeader>
        <CardTitle>{parcel.custom_name || parcel.code}</CardTitle>
        <CardDescription>
          {parcel.area_ha} ha ‚Ä¢ {parcel.soil_type === 'L' ? 'Lehk√°' : parcel.soil_type === 'S' ? 'St≈ôedn√≠' : 'Tƒõ≈æk√°'} p≈Øda
        </CardDescription>
      </CardHeader>
      <CardContent>
        {/* pH indik√°tor */}
        <NutrientBar 
          label="pH"
          value={analysis.ph}
          category={analysis.ph_category}
          min={4.5}
          max={7.5}
          optimal={[6.0, 6.8]}
        />
        
        {/* ≈Ωiviny */}
        <NutrientBar label="Fosfor (P)" value={analysis.p} category={analysis.p_category} />
        <NutrientBar label="Drasl√≠k (K)" value={analysis.k} category={analysis.k_category} />
        <NutrientBar label="Ho≈ôƒç√≠k (Mg)" value={analysis.mg} category={analysis.mg_category} />
        <NutrientBar label="S√≠ra (S)" value={analysis.s} category={analysis.s_category} />
        
        {/* Pomƒõr K:Mg */}
        <RatioIndicator 
          label="K:Mg"
          value={analysis.k_mg_ratio}
          optimal={[1.5, 2.5]}
          warning={[1.0, 3.0]}
        />
        
        {/* Metadata */}
        <div className="text-sm text-muted-foreground mt-4">
          Rozbor ze dne {formatDate(analysis.analysis_date)}
          {isAnalysisOld(analysis) && (
            <Badge variant="warning">Rozbor star≈°√≠ ne≈æ 4 roky</Badge>
          )}
        </div>
      </CardContent>
    </Card>
  );
}
```

Kategorie z√°sobenosti ‚Äì barvy:
```typescript
const CATEGORY_COLORS = {
  // pH
  EK: '#ef4444', // Extr√©mnƒõ kysel√° - ƒçerven√°
  SK: '#f97316', // Silnƒõ kysel√° - oran≈æov√°
  N: '#eab308',  // Neutr√°ln√≠ - ≈ælut√°
  SZ: '#84cc16', // Slabƒõ z√°sadit√° - zelen√°
  EZ: '#06b6d4', // Extr√©mnƒõ z√°sadit√° - cyan
  
  // ≈Ωiviny
  VH: '#ef4444', // Velmi n√≠zk√° - ƒçerven√°
  N: '#f97316',  // N√≠zk√° - oran≈æov√°
  D: '#22c55e',  // Dobr√° - zelen√°
  V: '#3b82f6',  // Vysok√° - modr√°
  VV: '#8b5cf6'  // Velmi vysok√° - fialov√°
};
```

Varov√°n√≠ a upozornƒõn√≠:
```tsx
const WARNING_TYPES = {
  high_p: {
    severity: 'warning',
    title: 'Vysok√° z√°sobenost fosforu',
    description: 'Dle vyhl√°≈°ky 377/2013 Sb. omezte hnojen√≠ P.'
  },
  low_ph: {
    severity: 'error',
    title: 'N√≠zk√© pH p≈Ødy',
    description: 'Doporuƒçujeme v√°pnƒõn√≠ p≈ôed aplikac√≠ hnojiv.'
  },
  k_mg_imbalance: {
    severity: 'warning',
    title: 'Nevyv√°≈æen√Ω pomƒõr K:Mg',
    description: 'Pomƒõr K:Mg je mimo optim√°ln√≠ rozmez√≠ 1.5-2.5.'
  },
  old_analysis: {
    severity: 'info',
    title: 'Star√Ω rozbor',
    description: 'Rozbor je star≈°√≠ ne≈æ 4 roky. Doporuƒçujeme nov√Ω odbƒõr.'
  },
  zod_area: {
    severity: 'warning',
    title: 'Zraniteln√° oblast',
    description: 'Pozemek se nach√°z√≠ v ZOD. Plat√≠ omezen√≠ hnojen√≠ dus√≠kem.'
  }
};
```

üì§ Export

PDF export pl√°nu hnojen√≠:
```typescript
import jsPDF from 'jspdf';

async function exportFertilizationPlanPDF(plan: FertilizationPlan, parcel: Parcel) {
  const doc = new jsPDF();
  
  // Logo D√©mon Agro
  const logo = await loadImage('/images/logo-demon-agro.png');
  doc.addImage(logo, 'PNG', 10, 10, 50, 20);
  
  // Hlaviƒçka
  doc.setFontSize(18);
  doc.text('Pl√°n hnojen√≠', 105, 40, { align: 'center' });
  
  doc.setFontSize(12);
  doc.text(`Pozemek: ${parcel.custom_name || parcel.code}`, 20, 55);
  doc.text(`V√Ωmƒõra: ${parcel.area_ha} ha`, 20, 62);
  doc.text(`C√≠lov√Ω rok: ${plan.target_year}`, 20, 69);
  
  // Doporuƒçen√≠ v√°pnƒõn√≠
  doc.setFontSize(14);
  doc.text('Doporuƒçen√≠ v√°pnƒõn√≠', 20, 85);
  doc.setFontSize(11);
  doc.text(`Mno≈æstv√≠: ${plan.recommended_lime_t_ha} t CaO/ha`, 25, 95);
  doc.text(`Typ: ${plan.recommended_lime_type === 'dolomite' ? 'Dolomitick√Ω' : 'Kalcitick√Ω'}`, 25, 102);
  
  // Doporuƒçen√© ≈æiviny
  doc.setFontSize(14);
  doc.text('Doporuƒçen√© d√°vky ≈æivin (kg/ha)', 20, 120);
  
  const nutrients = plan.recommended_nutrients;
  const nutrientTable = [
    ['≈Ωivina', 'D√°vka (kg/ha)'],
    ['P‚ÇÇO‚ÇÖ', nutrients.p2o5?.toString() || '-'],
    ['K‚ÇÇO', nutrients.k2o?.toString() || '-'],
    ['MgO', nutrients.mgo?.toString() || '-'],
    ['S', nutrients.s?.toString() || '-']
  ];
  
  doc.autoTable({
    startY: 125,
    head: [nutrientTable[0]],
    body: nutrientTable.slice(1),
    theme: 'grid'
  });
  
  // Varov√°n√≠
  if (plan.warnings?.length > 0) {
    doc.setFontSize(14);
    doc.text('Upozornƒõn√≠', 20, doc.lastAutoTable.finalY + 15);
    doc.setFontSize(10);
    plan.warnings.forEach((w, i) => {
      doc.text(`‚Ä¢ ${w.message}`, 25, doc.lastAutoTable.finalY + 25 + (i * 7));
    });
  }
  
  // Patiƒçka
  doc.setFontSize(9);
  doc.text('Vygenerov√°no port√°lem D√©mon Agro', 105, 280, { align: 'center' });
  doc.text(`Datum: ${new Date().toLocaleDateString('cs-CZ')}`, 105, 285, { align: 'center' });
  
  return doc.output('blob');
}
```

Excel export:
```typescript
import * as XLSX from 'xlsx';

function exportParcelsExcel(parcels: ParcelWithAnalysis[]) {
  const data = parcels.map(p => ({
    'K√≥d': p.code,
    'N√°zev': p.custom_name || '-',
    'V√Ωmƒõra (ha)': p.area_ha,
    'P≈Ødn√≠ druh': p.soil_type,
    'Kultura': p.culture === 'orna' ? 'Orn√° p≈Øda' : 'TTP',
    'pH': p.analysis?.ph || '-',
    'P (mg/kg)': p.analysis?.p || '-',
    'K (mg/kg)': p.analysis?.k || '-',
    'Mg (mg/kg)': p.analysis?.mg || '-',
    'S (mg/kg)': p.analysis?.s || '-',
    'K:Mg': p.analysis?.k_mg_ratio?.toFixed(2) || '-',
    'Datum rozboru': p.analysis?.analysis_date || '-'
  }));
  
  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Pozemky');
  
  return XLSX.write(wb, { type: 'buffer', bookType: 'xlsx' });
}
```

üè† Landing Page Port√°lu (/portal)

Obsah:

1. Hero sekce
   - Nadpis: "Port√°l pro spr√°vu p≈Ødn√≠ch rozbor≈Ø"
   - Popis: Kr√°tk√Ω text o v√Ωhod√°ch port√°lu
   - CTA: "P≈ôihl√°sit se" (odkaz na /portal/prihlaseni)

2. Sekce funkc√≠ (ikony + text)
   - Upload rozbor≈Ø a AI extrakce
   - Zdravotn√≠ karty pozemk≈Ø
   - Pl√°ny hnojen√≠ a v√°pnƒõn√≠
   - Export do PDF a Excel

3. Galerie screenshot≈Ø
   - Obr√°zky spravovan√© v admin sekci (tabulka portal_images)
   - Carousel nebo grid layout

4. CTA sekce
   - "M√°te z√°jem o p≈ô√≠stup?"
   - Kontaktn√≠ formul√°≈ô nebo odkaz na kontakt

Spr√°va obr√°zk≈Ø v admin:
```tsx
// Admin panel - spr√°va obr√°zk≈Ø port√°lu
function PortalImagesManager() {
  const [images, setImages] = useState<PortalImage[]>([]);
  
  async function uploadImage(file: File, title: string, description: string) {
    // 1. Upload do Supabase Storage
    const { data: fileData } = await supabase.storage
      .from('portal-images')
      .upload(`${Date.now()}-${file.name}`, file);
    
    // 2. Z√≠skat ve≈ôejnou URL
    const { data: { publicUrl } } = supabase.storage
      .from('portal-images')
      .getPublicUrl(fileData.path);
    
    // 3. Ulo≈æit do DB
    await supabase.from('portal_images').insert({
      title,
      description,
      image_url: publicUrl,
      display_order: images.length
    });
  }
  
  // Drag & drop ≈ôazen√≠, maz√°n√≠, editace...
}
```

üîß Konfigurace prost≈ôed√≠

.env.local:
```env
# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://xxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=xxx
SUPABASE_SERVICE_ROLE_KEY=xxx

# Anthropic (Claude API)
ANTHROPIC_API_KEY=xxx

# EmailJS (ji≈æ existuj√≠c√≠)
NEXT_PUBLIC_EMAILJS_SERVICE_ID=xxx
NEXT_PUBLIC_EMAILJS_TEMPLATE_ID=xxx
NEXT_PUBLIC_EMAILJS_PUBLIC_KEY=xxx

# Nov√© template pro notifikace popt√°vek
NEXT_PUBLIC_EMAILJS_LIMING_REQUEST_TEMPLATE_ID=xxx
```

Supabase setup:
```bash
# 1. Vytvo≈ô nov√Ω Supabase projekt (region: Frankfurt - EU)
# 2. Spus≈• SQL sch√©ma z t√©to dokumentace
# 3. Nastav Storage buckety:
#    - soil-documents (private)
#    - portal-images (public)
# 4. Nastav Edge Functions pro AI extrakci (voliteln√©)
```

‚ö†Ô∏è D≈Øle≈æit√© pozn√°mky

Zemƒõdƒõlsk√Ω rok:
```typescript
// Hospod√°≈ôsk√Ω rok (HY): 1. ≈ô√≠jna ‚Äì 30. z√°≈ô√≠
// HY2024/25 = 1.10.2024 ‚Äì 30.9.2025

function getHospodarskyRok(date: Date = new Date()): string {
  const month = date.getMonth(); // 0-11
  const year = date.getFullYear();
  
  // ≈ò√≠jen (9) a≈æ prosinec (11) = zaƒç√°tek nov√©ho HY
  if (month >= 9) {
    return `HY${year}/${(year + 1).toString().slice(-2)}`;
  }
  // Leden (0) a≈æ z√°≈ô√≠ (8) = pokraƒçov√°n√≠ p≈ôedchoz√≠ho HY
  return `HY${year - 1}/${year.toString().slice(-2)}`;
}
```

Validace vstupn√≠ch dat:
```typescript
const VALIDATION_RANGES = {
  ph: { min: 3.5, max: 9.0, suspicious: { min: 4.5, max: 8.0 } },
  p: { min: 0, max: 800, suspicious: { max: 300 } },
  k: { min: 0, max: 1200, suspicious: { max: 600 } },
  mg: { min: 0, max: 800, suspicious: { max: 400 } },
  area_ha: { min: 0.1, max: 1000, suspicious: { max: 100 } }
};
```

Co NEN√ç v MVP:
- Self-registrace u≈æivatel≈Ø
- V√≠ce u≈æivatel≈Ø na jeden podnik
- Offline re≈æim
- VDLUFA metodika (odlo≈æeno)
- Variabiln√≠ aplikaƒçn√≠ z√≥ny
- Automatick√© ceny s dopravou
- PDF export pl√°nu v√°pnƒõn√≠ (admin ≈ôe≈°√≠ ruƒçnƒõ)

üöÄ Po≈ôad√≠ implementace

F√°ze 1: Z√°klad
- Supabase setup + sch√©ma
- Autentizace + middleware
- Layout port√°lu + navigace
- Landing page /portal
- Onboarding wizard

F√°ze 2: Spr√°va pozemk≈Ø
- Seznam pozemk≈Ø
- Detail pozemku
- CRUD operace
- Rozdƒõlen√≠/slouƒçen√≠

F√°ze 3: Rozbory
- Upload PDF
- AI extrakce (Claude Vision)
- Validaƒçn√≠ UI
- P√°rov√°n√≠ s pozemky
- Verzov√°n√≠ rozbor≈Ø

F√°ze 4: Pl√°nov√°n√≠
- Jednoduch√Ω pl√°n (typ A)
- Pokroƒçil√Ω pl√°n (typ C)
- Pl√°n v√°pnƒõn√≠
- Popt√°vkov√Ω syst√©m

F√°ze 5: Admin + Export
- Admin dashboard
- Spr√°va u≈æivatel≈Ø
- Spr√°va produkt≈Ø
- P≈ôehled popt√°vek
- PDF/Excel export

üìö Reference
- Supabase Docs
- Next.js 14 App Router
- Anthropic Claude API
- Tailwind CSS
- Recharts
- jsPDF
- SheetJS

Tento prompt obsahuje kompletn√≠ specifikaci pro implementaci u≈æivatelsk√©ho port√°lu D√©mon Agro. Pou≈æij existuj√≠c√≠ design syst√©m projektu (barvy, fonty, komponenty) a dodr≈æuj ƒçeskou lokalizaci.
